<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mental Health Companion - Chat</title>
    <style>
      /* =================================
           CSS VARIABLES & BASE STYLES
        ================================= */
      :root {
        --primary-bg: #0f0f0f;
        --secondary-bg: #1a1a1a;
        --accent-dark: #305563;
        --accent-light: #81a4b7;
        --text-light: #ffffff;
        --text-muted: #b0b0b0;
        --text-dark: #2c2c2c;
        --bubble-sent: #81a4b7;
        --bubble-received: #305563;
        --shadow-color: rgba(0, 0, 0, 0.3);
        --glow-color: rgba(129, 164, 183, 0.3);
        --border-subtle: rgba(255, 255, 255, 0.1);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      .bubble.ollama {
        background: linear-gradient(135deg, var(--accent-dark), #4a7183) !important;
        border: 1px solid var(--accent-light) !important;
        box-shadow: 0 0 10px var(--glow-color) !important;
      }

      body {
        background: var(--primary-bg);
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        color: var(--text-light);
        height: 100vh;
        display: flex;
        flex-direction: column;
      }



      /* Apply to chat message area */
      .chat-messages-container::-webkit-scrollbar {
        width: 8px;
      }

      .chat-messages-container::-webkit-scrollbar-track {
        background: transparent;
      }

      .chat-messages-container::-webkit-scrollbar-thumb {
        background: #81a4b7;
        border-radius: 10px;
      }

      .chat-messages-container::-webkit-scrollbar-thumb:hover {
        background: #a2c4d9;
      }

      /* Firefox */
      .chat-messages-container {
        scrollbar-width: thin;
        scrollbar-color: #81a4b7 transparent;
      }

      /* =================================
           BACKGROUND PARTICLES
        ================================= */
      .background-particles {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
      }

      .particle {
        position: absolute;
        width: 2px;
        height: 2px;
        background: var(--accent-light);
        border-radius: 50%;
        opacity: 0.1;
        animation: float 8s infinite linear;
      }

      @keyframes float {
        0% {
          transform: translateY(100vh) rotate(0deg);
          opacity: 0;
        }
        10% {
          opacity: 0.1;
        }
        90% {
          opacity: 0.1;
        }
        100% {
          transform: translateY(-10px) rotate(360deg);
          opacity: 0;
        }
      }

      /* =================================
           MAIN LAYOUT
        ================================= */
      .chat-app {
        display: flex;
        height: 100vh;
        position: relative;
        z-index: 2;
      }

      /* =================================
           CHAT HISTORY SIDEBAR
        ================================= */
      .history-sidebar {
        width: 300px;
        background: var(--secondary-bg);
        border-right: 1px solid var(--border-subtle);
        display: flex;
        flex-direction: column;
        transition: transform 0.3s ease;
      }

      .history-sidebar.hidden {
        transform: translateX(-100%);
      }

      .history-header {
        padding: 20px;
        border-bottom: 1px solid var(--border-subtle);
        background: rgba(48, 85, 99, 0.1);
      }

      .history-header h3 {
        color: var(--accent-light);
        font-size: 1.1rem;
        margin-bottom: 5px;
      }

      .history-header p {
        color: var(--text-muted);
        font-size: 0.8rem;
      }

      .history-list {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
      }

      .history-item {
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid transparent;
        background: rgba(255, 255, 255, 0.02);
      }

      .history-item:hover {
        background: rgba(129, 164, 183, 0.1);
        border-color: var(--accent-light);
        box-shadow: 0 0 10px var(--glow-color);
      }

      .history-item.active {
        background: rgba(129, 164, 183, 0.2);
        border-color: var(--accent-light);
      }

      .history-item-title {
        font-size: 0.9rem;
        color: var(--text-light);
        margin-bottom: 5px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .history-item-preview {
        font-size: 0.75rem;
        color: var(--text-muted);
        line-height: 1.3;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .history-item-time {
        font-size: 0.7rem;
        color: var(--text-muted);
        margin-top: 8px;
      }

      /* =================================
           MAIN CHAT AREA
        ================================= */
      .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: var(--primary-bg);
      }

      .chat-header {
        padding: 20px 30px;
        border-bottom: 1px solid var(--border-subtle);
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: rgba(26, 26, 26, 0.8);
        backdrop-filter: blur(10px);
      }

      .chat-title {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .chat-title h2 {
        color: var(--text-light);
        font-size: 1.3rem;
      }

      .status-indicator {
        width: 8px;
        height: 8px;
        background: #4ade80;
        border-radius: 50%;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .toggle-history {
        background: none;
        border: 1px solid var(--accent-light);
        color: var(--accent-light);
        padding: 8px 15px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.8rem;
        transition: all 0.3s ease;
      }

      .toggle-history:hover {
        background: var(--accent-light);
        color: var(--primary-bg);
        box-shadow: 0 0 15px var(--glow-color);
      }

      /* =================================
           CHAT MESSAGES AREA
        ================================= */
      .chat-messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px 30px;
        background: rgba(0, 0, 0, 0.1);
      }

      .chat-messages {
        display: flex;
        flex-direction: column;
        gap: 20px;
        max-width: 800px;
        margin: 0 auto;
      }

      .message-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      /* =================================
           BUBBLE STYLES
        ================================= */
      .bubble {
        position: relative;
        max-width: 70%;
        padding: 15px 20px;
        border-radius: 20px;
        font-size: 0.95rem;
        line-height: 1.5;
        box-shadow: 0 4px 15px var(--shadow-color);
        animation: slideInUp 0.4s ease-out;
      }

      .bubble-left {
        background: var(--bubble-received);
        color: var(--text-light);
        align-self: flex-start;
        border-bottom-left-radius: 5px;
      }

      .bubble-left .point {
        position: absolute;
        bottom: 0;
        left: -8px;
        width: 0;
        height: 0;
        border-right: 15px solid var(--bubble-received);
        border-bottom: 15px solid transparent;
      }

      .bubble-right {
        background: var(--bubble-sent);
        color: var(--text-dark);
        align-self: flex-end;
        border-bottom-right-radius: 5px;
      }

      .bubble-right .point {
        position: absolute;
        bottom: 0;
        right: -8px;
        width: 0;
        height: 0;
        border-left: 15px solid var(--bubble-sent);
        border-bottom: 15px solid transparent;
      }

      @keyframes slideInUp {
        from {
          opacity: 0;
          transform: translateY(20px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .timestamp {
        font-size: 0.7rem;
        color: var(--text-muted);
        margin-top: 5px;
        opacity: 0.7;
      }

      .bubble-left + .timestamp {
        align-self: flex-start;
        margin-left: 15px;
      }

      .bubble-right + .timestamp {
        align-self: flex-end;
        margin-right: 15px;
      }

      /* =================================
           TYPING INDICATOR
        ================================= */
      .typing-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 15px 20px;
        background: var(--bubble-received);
        border-radius: 20px;
        border-bottom-left-radius: 5px;
        max-width: 80px;
        align-self: flex-start;
        position: relative;
        animation: slideInUp 0.4s ease-out;
      }

      .typing-indicator .point {
        position: absolute;
        bottom: 0;
        left: -8px;
        width: 0;
        height: 0;
        border-right: 15px solid var(--bubble-received);
        border-bottom: 15px solid transparent;
      }

      .typing-dots {
        display: flex;
        gap: 4px;
      }

      .dot {
        width: 6px;
        height: 6px;
        background: var(--text-light);
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out;
      }

      .dot:nth-child(1) {
        animation-delay: 0s;
      }
      .dot:nth-child(2) {
        animation-delay: 0.2s;
      }
      .dot:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typing {
        0%,
        60%,
        100% {
          transform: translateY(0);
          opacity: 0.4;
        }
        30% {
          transform: translateY(-8px);
          opacity: 1;
        }
      }

      /* =================================
           MESSAGE INPUT AREA
        ================================= */
      .message-input-container {
        padding: 20px 30px;
        border-top: 1px solid var(--border-subtle);
        background: rgba(26, 26, 26, 0.9);
        backdrop-filter: blur(10px);
      }

      .message-input-wrapper {
        display: flex;
        gap: 15px;
        align-items: flex-end;
        max-width: 800px;
        margin: 0 auto;
      }

      .message-input {
        flex: 1;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-subtle);
        border-radius: 25px;
        padding: 15px 20px;
        color: var(--text-light);
        font-size: 0.95rem;
        resize: none;
        min-height: 50px;
        max-height: 120px;
        outline: none;
        transition: all 0.3s ease;
      }

      .message-input:focus {
        border-color: var(--accent-light);
        box-shadow: 0 0 20px var(--glow-color);
        background: rgba(255, 255, 255, 0.08);
      }

      .message-input::placeholder {
        color: var(--text-muted);
      }

      .send-button {
        background: var(--accent-light);
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        color: var(--primary-bg);
        font-size: 1.2rem;
      }

      .send-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px var(--glow-color);
        background: #9bb8c9;
      }

      .send-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      /* =================================
           RESPONSIVE DESIGN
        ================================= */
      @media (max-width: 768px) {
        .history-sidebar {
          position: absolute;
          left: 0;
          top: 0;
          height: 100%;
          z-index: 10;
          box-shadow: 5px 0 15px rgba(0, 0, 0, 0.3);
        }

        .chat-messages-container {
          padding: 15px 20px;
        }

        .message-input-container {
          padding: 15px 20px;
        }

        .bubble {
          max-width: 85%;
          padding: 12px 16px;
          font-size: 0.9rem;
        }

        .chat-header {
          padding: 15px 20px;
        }
      }

      /* =================================
           NEW CHAT BUTTON
        ================================= */
      .new-chat-btn {
        margin: 15px;
        padding: 12px 20px;
        background: var(--accent-dark);
        color: var(--text-light);
        border: 1px solid var(--accent-light);
        border-radius: 25px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        text-align: center;
      }

      .new-chat-btn:hover {
        background: var(--accent-light);
        color: var(--primary-bg);
        box-shadow: 0 0 15px var(--glow-color);
      }
    </style>
  </head>

  <body>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chatMessages = document.getElementById('chatMessages');
            const userInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');

            // Add initial message
            addMessage("Welcome to your Mental Health Companion! To better understand how to help you, I'll ask you 5 quick questions. Let's begin with the first question: " + initial_questions[0], 'left');

            function addMessage(side, text, isOllama = false) {
                const messageGroup = document.createElement("div");
                messageGroup.className = "message-group";

                const bubble = document.createElement("div");
                bubble.className = `bubble bubble-${side}${isOllama ? ' ollama' : ''}`;
                bubble.innerHTML = `<div class="point"></div>${text}`;

                const timeElement = document.createElement("div");
                timeElement.className = "timestamp";
                timeElement.textContent = getCurrentTime();

                messageGroup.appendChild(bubble);
                messageGroup.appendChild(timeElement);
                chatMessages.appendChild(messageGroup);
                scrollToBottom();
            }        function sendMessage() {
          const message = userInput.value.trim();
          if (message) {
            addMessage(message, 'user');
            userInput.value = '';

            // Send message to server
            fetch('/get_response', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ message: message })
            })
            .then(response => response.json())
            .then(data => {
              if (data.assessment_complete) {
                // Assessment is complete, start normal conversation
                addMessage(data.response, 'bot');
              } else {
                // Continue with assessment questions
                addMessage(data.response, 'bot');
              }
            })
            .catch(error => {
              console.error('Error:', error);
              addMessage('Sorry, there was an error processing your message.', 'bot');
            });
          }
        }

        // Event listeners
        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            sendMessage();
          }
        });
      });
    </script>
    <!-- Background Particles -->
    <div class="background-particles" id="particles"></div>

    <div class="chat-app">
      <!-- Chat History Sidebar -->
      <div class="history-sidebar" id="historySidebar">
        <div class="history-header">
          <h3>Chat History</h3>
          <p>Your recent conversations</p>
        </div>

        <button class="new-chat-btn" onclick="startNewChat()">
          ✨ New Chat
        </button>

        <div class="history-list" id="historyList">
          <!-- History items will be populated here -->
        </div>
      </div>

      <!-- Main Chat Area -->
      <div class="chat-main">
        <!-- Chat Header -->
        <div class="chat-header">
          <div class="chat-title">
            <h2 id="chatTitle">AI Assistant</h2>
            <div class="status-indicator"></div>
          </div>
          <button class="toggle-history" onclick="toggleHistory()">
            <span id="toggleText">Hide History</span>
          </button>
        </div>

        <!-- Chat Messages -->
        <div class="chat-messages-container" id="messagesContainer">
          <div class="chat-messages" id="chatMessages">
            <!-- Welcome message -->
            <div class="message-group" id="initialMessage">
              <div class="bubble bubble-left">
                <div class="point"></div>
                Welcome to your Mental Health Companion! To better understand how to help you, I'll ask you 5 quick questions. First question: {{ first_question }}
              </div>
              <div class="timestamp" id="welcomeTime"></div>
            </div>
          </div>
        </div>

        <!-- Message Input -->
        <div class="message-input-container">
          <div class="message-input-wrapper">
            <textarea
              class="message-input"
              id="messageInput"
              placeholder="Type your message here..."
              rows="1"></textarea>
            <button class="send-button" id="sendButton" onclick="sendMessage()">
              ➤
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
        let isWaitingForResponse = false;
        let conversationEnded = false;
        let chatHistory = [];
        let currentChatId = null;

        // Initialize when document is ready
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            createParticles();
            setWelcomeTime();
            // The initial message is now handled by the HTML template
            // Additional setup if needed
        });

        function setupEventListeners() {
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');

            // Auto-resize textarea
            messageInput.addEventListener('input', autoResize);

            // Send message on Enter (but Shift+Enter for new line)
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Send button click
            sendButton.addEventListener('click', sendMessage);
        }

        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleTimeString([], {
                hour: "2-digit",
                minute: "2-digit"
            });
        }

        function setWelcomeTime() {
            document.getElementById("welcomeTime").textContent = getCurrentTime();
        }

        function autoResize() {
            const textarea = document.getElementById("messageInput");
            textarea.style.height = "auto";
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + "px";
        }

        function scrollToBottom() {
            const container = document.getElementById("messagesContainer");
            container.scrollTop = container.scrollHeight;
        }

        // Function to start a new chat
        function startNewChat() {
            // Navigate to the chat route which will reset the conversation
            window.location.href = '/chat';
        }

        async function sendMessage() {
            if (isWaitingForResponse || conversationEnded) return;

            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();

            if (!message) return;

            // Add user message to chat
            addMessage('right', message);
            messageInput.value = '';
            autoResize();

            // Show typing indicator
            isWaitingForResponse = true;
            showTypingIndicator();

            try {
                // Get last 4 messages for context
                const lastMessages = Array.from(document.querySelectorAll('.message-group'))
                    .slice(-4)
                    .map(group => {
                        const bubble = group.querySelector('.bubble');
                        return {
                            role: bubble.classList.contains('bubble-right') ? 'user' : 'assistant',
                            content: bubble.textContent.trim()
                        }
                    });

                const response = await fetch('/get_response', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        message: message,
                        conversation_history: lastMessages
                    })
                });

                const data = await response.json();
                hideTypingIndicator();

                // Add AI response to chat with special styling for Ollama responses
                if (data.source === 'ollama') {
                    addMessage('left', data.response, true);
                } else {
                    addMessage('left', data.response, false);
                }

                // If screening is complete and no more interaction needed, disable input
                if (data.response.includes("Now we know clearly about you")) {
                    document.getElementById('messageInput').disabled = false;
                    document.getElementById('sendButton').disabled = false;
                }
            } catch (error) {
                console.error('Error:', error);
                hideTypingIndicator();
                addMessage('left', 'Sorry, there was an error processing your message. Please try again.');
            }

            isWaitingForResponse = false;
        }

        function addMessage(side, text, isOllama = false) {
            const chatMessages = document.getElementById("chatMessages");
            const messageGroup = document.createElement("div");
            messageGroup.className = "message-group";

            const bubble = document.createElement("div");
            bubble.className = `bubble bubble-${side}`;
            bubble.innerHTML = `<div class="point"></div>${text}`;

            const timeElement = document.createElement("div");
            timeElement.className = "timestamp";
            timeElement.textContent = getCurrentTime();

            messageGroup.appendChild(bubble);
            messageGroup.appendChild(timeElement);
            chatMessages.appendChild(messageGroup);
            scrollToBottom();

            if (currentChatId) {
                saveMessageToChat(currentChatId, side, text, timeElement.textContent);
            }
        }

        function showTypingIndicator() {
            const chatMessages = document.getElementById("chatMessages");
            const typingIndicator = document.createElement("div");
            typingIndicator.className = "typing-indicator";
            typingIndicator.id = "typingIndicator";
            typingIndicator.innerHTML = `
                <div class="point"></div>
                <div class="typing-dots">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            `;
            chatMessages.appendChild(typingIndicator);
            scrollToBottom();
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById("typingIndicator");
            if (indicator) {
                indicator.remove();
            }
        }

        // Chat History Management
        function startNewChat() {
            const chatId = "chat_" + Date.now();
            const newChat = {
                id: chatId,
                title: "New Conversation",
                preview: "Hello! I'm your AI assistant...",
                timestamp: new Date().toISOString(),
                messages: []
            };
            chatHistory.unshift(newChat);
            saveChatHistory();
            renderHistoryList();
            loadChat(chatId);
        }

        function loadChat(chatId) {
            currentChatId = chatId;
            const chat = chatHistory.find(c => c.id === chatId);
            if (!chat) return;

            const chatMessages = document.getElementById("chatMessages");
            chatMessages.innerHTML = "";
            
            chat.messages.forEach(msg => {
                addMessage(msg.side, msg.text);
            });

            document.getElementById("chatTitle").textContent = chat.title;
            document.querySelectorAll(".history-item").forEach(item => {
                item.classList.remove("active");
            });
            document.querySelector(`[data-chat-id="${chatId}"]`)?.classList.add("active");
        }

        function saveMessageToChat(chatId, side, text) {
            const chat = chatHistory.find(c => c.id === chatId);
            if (!chat) return;

            chat.messages.push({ side, text, timestamp: getCurrentTime() });
            
            if (side === "right" && chat.messages.length === 1) {
                chat.title = text.substring(0, 30) + (text.length > 30 ? "..." : "");
                chat.preview = text.substring(0, 50) + (text.length > 50 ? "..." : "");
                document.getElementById("chatTitle").textContent = chat.title;
            }
            
            saveChatHistory();
            renderHistoryList();
        }

        function loadChatHistory() {
            const saved = localStorage.getItem("chatHistory");
            if (saved) {
                chatHistory = JSON.parse(saved);
                renderHistoryList();
            }
        }

        function saveChatHistory() {
            localStorage.setItem("chatHistory", JSON.stringify(chatHistory));
        }

        function renderHistoryList() {
            const historyList = document.getElementById("historyList");
            historyList.innerHTML = "";
            
            chatHistory.forEach(chat => {
                const item = document.createElement("div");
                item.className = "history-item";
                item.setAttribute("data-chat-id", chat.id);
                item.onclick = () => loadChat(chat.id);

                const timeStr = new Date(chat.timestamp).toLocaleString([], {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                item.innerHTML = `
                    <div class="history-item-title">${chat.title}</div>
                    <div class="history-item-preview">${chat.preview}</div>
                    <div class="history-item-time">${timeStr}</div>
                `;
                historyList.appendChild(item);
            });
        }

        function toggleHistory() {
            const sidebar = document.getElementById("historySidebar");
            const toggleText = document.getElementById("toggleText");
            sidebar.classList.toggle("hidden");
            toggleText.textContent = sidebar.classList.contains("hidden") 
                ? "Show History" 
                : "Hide History";
        }

        function createParticles() {
            const container = document.getElementById("particles");
            const particleCount = 50;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement("div");
                particle.className = "particle";
                particle.style.left = Math.random() * 100 + "%";
                particle.style.animationDelay = Math.random() * 8 + "s";
                particle.style.animationDuration = 8 + Math.random() * 4 + "s";
                container.appendChild(particle);
            }
        }
    </script>
    </script>
  </body>
</html>
